<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-mini S&P 500 Risk Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-label {
            @apply block text-sm font-medium text-gray-400 mb-2;
        }
        /* UPDATED: Changed input fields to a light theme for visibility */
        .input-field {
            @apply w-full bg-white border border-gray-300 text-black rounded-md p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition;
        }
        .btn-primary {
            @apply w-full bg-indigo-600 text-white font-semibold py-3 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500 transition duration-150;
        }
        .card {
            @apply bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700;
        }
        .radio-label {
            @apply flex items-center justify-center w-full p-3 text-gray-400 bg-gray-700 border-2 border-gray-600 rounded-lg cursor-pointer hover:text-white hover:bg-gray-600 transition;
        }
        .radio-label input:checked + div {
            @apply bg-indigo-600 border-indigo-500 text-white;
        }
        /* Custom styles for results table */
        th { @apply px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider; }
        td { @apply px-4 py-4 whitespace-nowrap text-sm text-gray-200; }
        .highlight { @apply text-indigo-400 font-semibold; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="card">
            <h1 class="text-2xl font-bold text-center mb-6">E-mini S&P 500 Risk Calculator</h1>
            
            <div class="space-y-4">
                <div>
                    <label for="swingLow" class="input-label">Swing Low / Support</label>
                    <input type="number" id="swingLow" class="input-field" value="5928">
                </div>
                <div>
                    <label for="swingHigh" class="input-label">Swing High / Resistance</label>
                    <input type="number" id="swingHigh" class="input-field" value="6074">
                </div>
                <div>
                    <label for="totalRisk" class="input-label">Total Risk Amount ($)</label>
                    <input type="number" id="totalRisk" class="input-field" value="10000">
                </div>
                
                <div>
                    <label class="input-label">Trade Direction</label>
                    <ul class="grid w-full grid-cols-2 gap-4">
                        <li>
                            <input type="radio" id="long" name="direction" value="long" class="hidden peer" checked>
                            <label for="long" class="radio-label">
                                <div class="block w-full text-center">Long</div>
                            </label>
                        </li>
                        <li>
                            <input type="radio" id="short" name="direction" value="short" class="hidden peer">
                            <label for="short" class="radio-label">
                                <div class="block w-full text-center">Short</div>
                            </label>
                        </li>
                    </ul>
                </div>

                <div>
                    <label for="strategy" class="input-label">Risk Allocation Strategy</label>
                    <select id="strategy" class="input-field">
                        <option value="equal">Equal Risk (33.3% each)</option>
                        <option value="conservative">Conservative (20% / 40% / 40%)</option>
                        <option value="aggressive">Aggressive (50% / 30% / 20%)</option>
                    </select>
                </div>

                <button id="calculateBtn" class="btn-primary !mt-6">Calculate Position Size</button>
            </div>
        </div>

        <div id="resultsContainer" class="card hidden">
            <h2 class="text-xl font-bold text-center mb-4">Trade Plan</h2>
            <div id="resultsTable" class="overflow-x-auto"></div>
            <div id="summary" class="mt-4 pt-4 border-t border-gray-700"></div>
            <div id="strategyExplanation" class="mt-4 p-4 bg-gray-900/50 rounded-lg text-sm text-gray-400"></div>
        </div>
    </div>

    <script>
        // --- Constants ---
        const POINT_VALUE = 50; // For E-mini S&P 500 (/ES)
        const FIB_LEVELS = [0.5, 0.618, 0.786];
        const STRATEGIES = {
            equal: [1/3, 1/3, 1/3],
            conservative: [0.2, 0.4, 0.4],
            aggressive: [0.5, 0.3, 0.2]
        };

        // --- DOM Elements ---
        const swingLowEl = document.getElementById('swingLow');
        const swingHighEl = document.getElementById('swingHigh');
        const totalRiskEl = document.getElementById('totalRisk');
        const directionEl = () => document.querySelector('input[name="direction"]:checked');
        const strategyEl = document.getElementById('strategy');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsTable = document.getElementById('resultsTable');
        const summaryEl = document.getElementById('summary');
        const strategyExplanationEl = document.getElementById('strategyExplanation');

        // --- Event Listener ---
        calculateBtn.addEventListener('click', calculateAndDisplay);

        // --- Main Calculation Logic ---
        function calculateAndDisplay() {
            // 1. Get and validate inputs
            const low = parseFloat(swingLowEl.value);
            const high = parseFloat(swingHighEl.value);
            const totalRisk = parseFloat(totalRiskEl.value);
            const direction = directionEl().value;
            const strategy = STRATEGIES[strategyEl.value];

            if (isNaN(low) || isNaN(high) || isNaN(totalRisk) || low >= high || totalRisk <= 0) {
                alert("Please enter valid inputs. Swing High must be greater than Swing Low, and Risk must be positive.");
                return;
            }

            // 2. Setup calculation variables
            const range = high - low;
            const stopLoss = direction === 'long' ? low : high;

            let results = [];
            let totalContracts = 0;
            let totalWeightedPrice = 0;
            let totalActualRisk = 0;
            
            // 3. Calculate for each Fibonacci level
            FIB_LEVELS.forEach((fib, index) => {
                let entryPrice;
                if (direction === 'long') {
                    // For a long, we buy a pullback from the high
                    entryPrice = high - (range * fib);
                } else {
                    // For a short, we sell a rally from the low
                    entryPrice = low + (range * fib);
                }
                entryPrice = roundToTick(entryPrice);

                const riskInPoints = Math.abs(entryPrice - stopLoss);
                const riskPerContract = riskInPoints * POINT_VALUE;
                const allocatedRisk = totalRisk * strategy[index];
                const positionSize = (riskPerContract > 0) ? allocatedRisk / riskPerContract : 0;
                
                totalContracts += positionSize;
                totalWeightedPrice += positionSize * entryPrice;
                totalActualRisk += positionSize * riskPerContract;

                results.push({
                    level: `${(fib * 100).toFixed(1)}%`,
                    entryPrice: entryPrice.toFixed(2),
                    riskPerContract: riskPerContract.toFixed(2),
                    allocatedRisk: allocatedRisk.toFixed(2),
                    positionSize: positionSize.toFixed(2)
                });
            });

            // 4. Calculate summary metrics
            const averageEntryPrice = totalContracts > 0 ? (totalWeightedPrice / totalContracts).toFixed(2) : 'N/A';

            // 5. Render the output
            renderResults(results, stopLoss.toFixed(2));
            renderSummary(totalContracts, averageEntryPrice, totalActualRisk);
            renderStrategyExplanation();

            resultsContainer.classList.remove('hidden');
        }
        
        // --- Helper Functions ---
        function roundToTick(price) {
            // E-mini S&P 500 tick size is 0.25
            return Math.round(price * 4) / 4;
        }

        // --- Rendering Functions ---
        function renderResults(data, stopLoss) {
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800">
                        <tr>
                            <th>Fib Level</th>
                            <th>Entry Price</th>
                            <th>Stop Loss</th>
                            <th>Risk / Contract</th>
                            <th>Position Size</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-800/50 divide-y divide-gray-700">
            `;
            data.forEach(row => {
                tableHTML += `
                    <tr>
                        <td>${row.level}</td>
                        <td><span class="highlight">${row.entryPrice}</span></td>
                        <td>${stopLoss}</td>
                        <td>$${row.riskPerContract}</td>
                        <td><span class="font-bold text-lg text-white">${row.positionSize}</span></td>
                    </tr>
                `;
            });
            tableHTML += `</tbody></table>`;
            resultsTable.innerHTML = tableHTML;
        }

        function renderSummary(totalContracts, avgPrice, totalRisk) {
            summaryEl.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-sm text-gray-400">Total Size</p>
                        <p class="text-2xl font-bold text-white">${totalContracts.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">contracts</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Average Entry Price</p>
                        <p class="text-2xl font-bold text-white">${avgPrice}</p>
                         <p class="text-xs text-gray-500">(if all levels filled)</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Total Actual Risk</p>
                        <p class="text-2xl font-bold text-white">$${totalRisk.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                         <p class="text-xs text-gray-500">(vs. $${parseFloat(totalRiskEl.value).toLocaleString()})</p>
                    </div>
                </div>
            `;
        }

        function renderStrategyExplanation() {
            const strategyKey = strategyEl.value;
            let explanation = '';
            if (strategyKey === 'aggressive') {
                explanation = `<strong>Aggressive Strategy:</strong> You are front-loading your risk (50% on the first level). This is effective if you expect a shallow pullback, getting you into a larger position early. The drawback is a less favorable average price if the market moves to deeper levels.`;
            } else if (strategyKey === 'conservative') {
                explanation = `<strong>Conservative Strategy:</strong> You are back-loading your risk (40% on the two deeper levels). This gives you the best possible average entry price if all levels are filled. The risk is that the market may not pull back deeply enough, leaving you with a smaller position or no entry at all.`;
            } else {
                explanation = `<strong>Equal Risk Strategy:</strong> Your risk is evenly distributed across all three potential entry points. This is a balanced approach that doesn't favor any single level, providing a moderate average price and consistent risk exposure at each stage of entry.`;
            }
            strategyExplanationEl.innerHTML = explanation;
        }

        // --- Initial Calculation on Load ---
        document.addEventListener('DOMContentLoaded', calculateAndDisplay);
    </script>
</body>
</html>
